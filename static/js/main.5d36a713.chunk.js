(this["webpackJsonpred-light"]=this["webpackJsonpred-light"]||[]).push([[0],{15:function(e,t,a){e.exports=a(26)},26:function(e,t,a){"use strict";a.r(t);var o=a(0),n=a.n(o),i=a(7),r=a(8),s=a(5),u=a(6),d=a(14),c=a.n(d);function l(e,t,a,o){return new Promise((function(n,i){var r=new XMLHttpRequest,s="https://api.twilio.com/2010-04-01/Accounts/"+e+"/Calls.json?StartTime>="+encodeURIComponent(o.toISOString())+"&From="+encodeURIComponent(a)+"&PageSize=1000";r.open("GET",s,!0),r.setRequestHeader("Authorization","Basic "+window.btoa(e+":"+t)),r.onreadystatechange=function(){if(r.readyState===XMLHttpRequest.DONE&&200===r.status){var a=JSON.parse(r.responseText),o=Object(u.a)(a.calls);if(a.next_page_uri)(function e(t,a,o,n){return new Promise((function(i,r){var s=new XMLHttpRequest;s.open("GET","https://api.twilio.com"+o,!0),s.setRequestHeader("Authorization","Basic "+window.btoa(t+":"+a)),s.onreadystatechange=function(){if(s.readyState===XMLHttpRequest.DONE&&200===s.status){var o=JSON.parse(s.responseText),r=n.concat(Object(u.a)(o.calls));if(o.next_page_uri)e(t,a,o.next_page_uri,r).then((function(e){return i(e)}));else i(r)}},s.send()}))})(e,t,a.next_page_uri,o).then((function(e){return n(e)}));else n(o)}},r.send()}))}function S(e,t,a,o,n){var i=new XMLHttpRequest;i.open("POST","https://api.twilio.com/2010-04-01/Accounts/"+e+"/Calls.json",!0),i.setRequestHeader("Content-type","application/x-www-form-urlencoded"),i.setRequestHeader("Authorization","Basic "+window.btoa(e+":"+t)),i.onreadystatechange=function(){i.readyState===XMLHttpRequest.DONE&&i.status};var r="To="+a+"&From="+o+"&Url="+n;i.send(encodeURI(r))}function p(e,t,a,o){S(e.TwilioSid,e.TwilioToken,t,e.TwilioNumbers[a],e.AudioURIs[o])}function w(e,t,a,o,n){var i=new XMLHttpRequest;i.open("POST","https://api.twilio.com/2010-04-01/Accounts/"+e+"/Messages.json",!0),i.setRequestHeader("Content-type","application/x-www-form-urlencoded"),i.setRequestHeader("Authorization","Basic "+window.btoa(e+":"+t)),i.onreadystatechange=function(){i.readyState===XMLHttpRequest.DONE&&i.status};var r="To="+a+"&From="+o+"&Body="+n;i.send(encodeURI(r))}function m(e,t,a,o){w(e.TwilioSid,e.TwilioToken,t,e.TwilioNumbers[a],o)}var h=Object.freeze({idle:1,configured:2,ready:3,running:4,stopped:5}),b={Start:new Date,Stop:new Date,Mode:h.idle,Cost:0,Numbers:Object(u.b)({}),AudioURIs:[],PreShowSMS:"",PostShowSMS:"",PreShowWait:0,RedialWindow:0,RedialWait:0,PostShowWait:0,TwilioSid:"",TwilioToken:"",TwilioNumbers:[]};function T(e,t,a,o){return m(e,t,a.idx,e.PreShowSMS),{State:a.State,Started:a.Started,Status:"preshow",Update:f,DateCreated:a.DateCreated,QueueTime:a.QueueTime,Duration:a.Duration,Attempts:a.Attempts,idx:a.idx,udx:a.udx}}function f(e,t,a,o){var n=(new Date-e.Start)/6e4,i=a.Status,r=a.Update,s=a.Attempts;return n>e.PreShowWait&&(console.log("**StartCall**"),p(e,t,a.idx,a.udx),i="started",r=v,s=1),{State:a.state,Started:a.Started,Status:i,Update:r,DateCreated:a.DateCreated,QueueTime:a.QueueTime,Duration:a.Duration,Attempts:s,idx:a.idx,udx:a.udx}}function v(e,t,a,o){var n=new Date;if(void 0===o)return a;var i=o.duration/60;"in-progress"===o.status&&(i=(n-new Date(o.start_time))/6e4);var r=a.Status,s=a.Started,u=a.Update;"completed"!==o.status&&"failed"!==o.status&&"busy"!==o.status&&"no-answer"!==o.status||(void 0===s&&(s=new Date(o.start_time)),(n-s)/6e4<e.RedialWindow&&a.Attempts<4?(r="redial",u=O):(r="postshow",u=R));return{State:o.status,Started:s,Status:r,Update:u,DateCreated:o.date_created,QueueTime:o.queue_time/1e3,Duration:i,Attempts:a.Attempts,idx:a.idx,udx:a.udx}}function O(e,t,a,o){var n=(new Date-new Date(o.end_time))/6e4;if(void 0===o)return a;var i=a.Status,r=a.Update,s=a.Attempts;return n>e.RedialWait&&(console.log("**StartCall**"),p(e,t,a.idx,a.udx),i="started",r=v,s+=1),{State:o.status,Started:a.Started,Status:i,Update:r,DateCreated:o.date_created,QueueTime:o.queue_time/1e3,Duration:o.duration/60,Attempts:s,idx:a.idx,udx:a.udx}}function R(e,t,a,o){var n=(new Date-new Date(o.end_time))/6e4;if(void 0===o)return a;var i=a.Status,r=a.Update;return n>e.PostShowWait&&(console.log("**StartSMS**"),m(e,t,a.idx,e.PostShowSMS),r=P),{State:o.status,Started:a.Started,Status:i,Update:r,DateCreated:o.date_created,QueueTime:o.queue_time/1e3,Duration:o.duration/60,Attempts:a.Attempts,idx:a.idx,udx:a.udx}}function P(e,t,a,o){return a}var M=a(1),N=a(2),g=a(4),E=a(3),A=function(e){Object(g.a)(a,e);var t=Object(E.a)(a);function a(){return Object(M.a)(this,a),t.apply(this,arguments)}return Object(N.a)(a,[{key:"render",value:function(){var e=this.props.num,t=this.props.call;return n.a.createElement("div",{className:"pure-u-1-5 card "+t.Status+" "+t.State,key:e},n.a.createElement("p",null,"\xa0",e," (",t.Status,")"),n.a.createElement("p",{className:"cardDetail"},"\xa0D:",t.Duration.toFixed(2),"m Q:",t.QueueTime.toFixed(1),"s T:",t.Attempts," ",t.State))}}]),a}(n.a.Component),W=function(e){Object(g.a)(a,e);var t=Object(E.a)(a);function a(){return Object(M.a)(this,a),t.apply(this,arguments)}return Object(N.a)(a,[{key:"render",value:function(){var e=this.props.row,t=this.props.cols,a=this.props.numbers,o=[],i=0;for(i=0;i<t.size;i++){var r=t.get(i);r.get(e)&&o.push(n.a.createElement(A,{key:r.get(e),num:r.get(e),call:a.get(r.get(e))}))}return n.a.createElement("div",{className:"pure-g"},o)}}]),a}(n.a.Component),j=function(e){Object(g.a)(a,e);var t=Object(E.a)(a);function a(){return Object(M.a)(this,a),t.apply(this,arguments)}return Object(N.a)(a,[{key:"render",value:function(){var e=this.props.state,t=[],a=e.Numbers.keySeq().groupBy((function(e,t){return t%5}));if(a.size>0){var o=a.get(0).size,i=0;for(i=0;i<o;i++)t.push(n.a.createElement(W,{key:"row"+i,numbers:e.Numbers,cols:a,row:i}))}return n.a.createElement("div",{className:e.Mode===h.idle||e.Mode===h.configured?"hidden":""},n.a.createElement("h2",null,"Contacts: "),t)}}]),a}(n.a.Component),C=Object(s.b)((function(e){return{state:e}}))(j),y=function(e){Object(g.a)(a,e);var t=Object(E.a)(a);function a(){return Object(M.a)(this,a),t.apply(this,arguments)}return Object(N.a)(a,[{key:"render",value:function(){var e=this,t=this.props.state;return n.a.createElement("button",{className:t.Mode===h.idle?"fileUpload pure-button pure-button-primary":"hidden"},n.a.createElement("span",null,"Load Settings"),n.a.createElement("input",{id:"settings-file",className:"upload",type:"file",accept:".json",onChange:function(t){var a=t.target.files[0];if(a){var o=new FileReader;o.onload=function(t){e.props.dispatch({type:"LOAD_SETTINGS",contents:t.target.result})},o.readAsText(a)}}}))}}]),a}(n.a.Component),D=Object(s.b)((function(e){return{state:e}}))(y),x=function(e){Object(g.a)(a,e);var t=Object(E.a)(a);function a(){return Object(M.a)(this,a),t.apply(this,arguments)}return Object(N.a)(a,[{key:"render",value:function(){var e=this,t=this.props.state;return n.a.createElement("div",{className:t.Mode===h.configured?"fileUpload button-secondary pure-button":"hidden"},n.a.createElement("span",null,"Load Contacts"),n.a.createElement("input",{id:"settings-file",className:"upload",type:"file",accept:".csv,.CSV",onChange:function(t){var a=t.target.files[0];if(a){var o=new FileReader;o.onload=function(t){e.props.dispatch({type:"LOAD_CONTACTS",contents:t.target.result})},o.readAsText(a)}}}))}}]),a}(n.a.Component),U=Object(s.b)((function(e){return{state:e}}))(x),k=function(e){Object(g.a)(a,e);var t=Object(E.a)(a);function a(){return Object(M.a)(this,a),t.apply(this,arguments)}return Object(N.a)(a,[{key:"render",value:function(){var e=this.props.state,t="",a="",o="";return e.Mode!==h.running&&e.Mode!==h.stopped||(a="House: "+e.Numbers.count(),t="Start: "+e.Start),e.Mode===h.running?o="Elapsed: "+((new Date-e.Start)/6e4).toFixed(2)+"min":e.Mode===h.stopped&&(o="Elapsed: "+((e.Stop-e.Start)/6e4).toFixed(2)+"min"),n.a.createElement("div",{className:e.Mode!==h.idle?"settings":"hidden"},n.a.createElement("p",null,"TwilioNumbers: ",e.TwilioNumbers.toString(),n.a.createElement("br",null),a,n.a.createElement("br",null),t,n.a.createElement("br",null),o,n.a.createElement("br",null),"State Machine:",-e.Cost.toFixed(2)))}}]),a}(n.a.Component),_=Object(s.b)((function(e){return{state:e}}))(k),I=function(e){Object(g.a)(a,e);var t=Object(E.a)(a);function a(){return Object(M.a)(this,a),t.apply(this,arguments)}return Object(N.a)(a,[{key:"render",value:function(){var e=this,t=this.props.state;return n.a.createElement("button",{className:t.Mode===h.ready?"pure-button pure-button-primary add":"hidden",onClick:function(t){var a;e.props.dispatch({type:"START_PERFORMANCE",contents:a})}},"Start Performance")}}]),a}(n.a.Component),F=Object(s.b)((function(e){return{state:e}}))(I),q=function(e){Object(g.a)(a,e);var t=Object(E.a)(a);function a(){return Object(M.a)(this,a),t.apply(this,arguments)}return Object(N.a)(a,[{key:"render",value:function(){var e=this,t=this.props.state;return n.a.createElement("button",{className:t.Mode===h.running?"pure-button button-error add":"hidden",onClick:function(t){var a;e.props.dispatch({type:"STOP_PERFORMANCE",contents:a})}},"Stop Performance")}}]),a}(n.a.Component),L=Object(s.b)((function(e){return{state:e}}))(q),H=function(e){Object(g.a)(a,e);var t=Object(E.a)(a);function a(){return Object(M.a)(this,a),t.apply(this,arguments)}return Object(N.a)(a,[{key:"loadFromServer",value:function(){var e,t,a,o,n=this,i=this.props.state;""!==i.TwilioSid&&""!==i.TwilioToken&&(e=i.TwilioSid,t=i.TwilioToken,a=i.TwilioNumbers,o=i.Start,Promise.all(a.map((function(a){return l(e,t,a,o)})))).then((function(e){var t=e.reduce((function(e,t){return e.concat(t)}),Object(u.a)()),a=t.reduce((function(e,t){return t.price?e+parseFloat(t.price):e+0}),0),o=t.reduce((function(e,t){var a=e.get(t.to);return void 0===a||t.date_created>=a.DateCreated?e.set(t.to,t):e}),Object(u.b)());n.props.dispatch({type:"UPDATE_STATE",contents:[o,a]})}))}},{key:"componentDidMount",value:function(){var e=this;this.interval=setInterval((function(){e.setState({time:Date.now()}),e.loadFromServer()}),2e3)}},{key:"componentWillUnmount",value:function(){clearInterval(this.interval)}},{key:"render",value:function(){return n.a.createElement("div",{className:"pure-g"},n.a.createElement("div",{className:"pure-u-1-1"},n.a.createElement("h1",null,"Red Light Switchboard"),n.a.createElement(_,null),n.a.createElement("fieldset",{className:"pure-form"},n.a.createElement(D,null),n.a.createElement(U,null),n.a.createElement(F,null),n.a.createElement(L,null)),n.a.createElement(C,null)))}}]),a}(n.a.Component),Q=Object(s.b)((function(e){return{state:e}}))(H),z=Object(r.b)((function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:b,t=arguments.length>1?arguments[1]:void 0;switch(t.type){case"LOAD_SETTINGS":console.log("LOAD SETTINGS");var a=JSON.parse(t.contents);return{Start:e.Start,Stop:e.Stop,Mode:h.configured,Cost:e.Cost,Numbers:e.Numbers,AudioURIs:a.AudioURIs,PreShowSMS:a.PreShowSMS,PostShowSMS:a.PostShowSMS,PreShowWait:a.PreShowWait,RedialWindow:a.RedialWindow,RedialWait:a.RedialWait,PostShowWait:a.PostShowWait,TwilioSid:a.TwilioSid,TwilioToken:a.TwilioToken,TwilioNumbers:a.TwilioNumbers};case"LOAD_CONTACTS":console.log("LOAD CONTACTS");var o=0,n=0,i=Object(u.c)(c.a.parse(t.contents).data),r=i.filter((function(e){return""!==e.get(14)})).map((function(e){return e.get(14)})).map((function(e){return e.startsWith("0")?"+61"+e.substring(1):"+"+e})).reduce((function(t,a){return o=(o+1)%e.TwilioNumbers.length,n=(n+1)%e.AudioURIs.length,t.set(a,{State:"",Started:void 0,Status:"imported",Update:T,DateCreated:new Date,QueueTime:0,Duration:0,Attempts:0,idx:o,udx:n})}),Object(u.b)());return{Start:e.Start,Stop:e.Stop,Mode:h.ready,Cost:e.Cost,Numbers:r,AudioURIs:e.AudioURIs,PreShowSMS:e.PreShowSMS,PostShowSMS:e.PostShowSMS,PreShowWait:e.PreShowWait,RedialWindow:e.RedialWindow,RedialWait:e.RedialWait,PostShowWait:e.PostShowWait,TwilioSid:e.TwilioSid,TwilioToken:e.TwilioToken,TwilioNumbers:e.TwilioNumbers};case"START_PERFORMANCE":return console.log("START PERFORMANCE"),{Start:new Date,Stop:e.Stop,Mode:h.running,Cost:e.Cost,Numbers:e.Numbers,AudioURIs:e.AudioURIs,PreShowSMS:e.PreShowSMS,PostShowSMS:e.PostShowSMS,PreShowWait:e.PreShowWait,RedialWindow:e.RedialWindow,RedialWait:e.RedialWait,PostShowWait:e.PostShowWait,TwilioSid:e.TwilioSid,TwilioToken:e.TwilioToken,TwilioNumbers:e.TwilioNumbers};case"STOP_PERFORMANCE":return console.log("STOP PERFORMANCE"),{Start:e.Start,Stop:new Date,Mode:h.stopped,Cost:e.Cost,Numbers:e.Numbers,AudioURIs:e.AudioURIs,PreShowSMS:e.PreShowSMS,PostShowSMS:e.PostShowSMS,PreShowWait:e.PreShowWait,RedialWindow:e.RedialWindow,RedialWait:e.RedialWait,PostShowWait:e.PostShowWait,TwilioSid:e.TwilioSid,TwilioToken:e.TwilioToken,TwilioNumbers:e.TwilioNumbers};case"UPDATE_STATE":if(e.Mode!==h.running)return{Start:e.Start,Stop:e.Stop,Mode:e.Mode,Cost:t.contents[1],Numbers:e.Numbers,AudioURIs:e.AudioURIs,PreShowSMS:e.PreShowSMS,PostShowSMS:e.PostShowSMS,PreShowWait:e.PreShowWait,RedialWindow:e.RedialWindow,RedialWait:e.RedialWait,PostShowWait:e.PostShowWait,TwilioSid:e.TwilioSid,TwilioToken:e.TwilioToken,TwilioNumbers:e.TwilioNumbers};var s=e.Numbers.map((function(a,o){return a.Update(e,o,a,t.contents[0].get(o))})),d=s.filter((function(e){return e.Update===P})),l=d.count()===s.count();return{Start:e.Start,Stop:l?new Date:e.Stop,Mode:l?h.stopped:e.Mode,Cost:t.contents[1],Numbers:s,AudioURIs:e.AudioURIs,PreShowSMS:e.PreShowSMS,PostShowSMS:e.PostShowSMS,PreShowWait:e.PreShowWait,RedialWindow:e.RedialWindow,RedialWait:e.RedialWait,PostShowWait:e.PostShowWait,TwilioSid:e.TwilioSid,TwilioToken:e.TwilioToken,TwilioNumbers:e.TwilioNumbers};default:return console.log("DEFAULT"),e}}));Object(i.render)(n.a.createElement(s.a,{store:z},n.a.createElement(Q,null)),document.getElementById("root"))}},[[15,1,2]]]);
//# sourceMappingURL=main.5d36a713.chunk.js.map